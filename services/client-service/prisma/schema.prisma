generator client {
  provider        = "prisma-client-js"
  output          = "../src/generated/prisma"
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["app_clients"]
}

// Enums
enum Gender {
  male
  female
  other
  prefer_not_to_say

  @@schema("app_clients")
}

enum MaritalStatus {
  single
  married
  divorced
  widowed

  @@schema("app_clients")
}

enum ClientSource {
  manual
  website
  import
  ocr

  @@schema("app_clients")
}

enum BirthTimeAccuracy {
  exact
  approximate
  rectified
  unknown

  @@schema("app_clients")
}

enum RelationshipType {
  spouse
  child
  parent
  sibling
  grandparent
  grandchild
  in_law
  uncle_aunt
  nephew_niece
  cousin
  other

  @@schema("app_clients")
}

enum ConsultationType {
  general
  career
  marriage
  health
  business
  muhurta
  compatibility
  annual
  transit
  other

  @@schema("app_clients")
}

enum ConsultationStatus {
  completed
  pending_follow_up
  closed

  @@schema("app_clients")
}

enum ChartType {
  D1
  D2
  D3
  D4
  D6
  D7
  D9
  D10
  D12
  D16
  D20
  D24
  D27
  D30
  D40
  D45
  D60
  D150
  transit
  dasha
  ashtakavarga
  ashtakavarga_bhinna
  ashtakavarga_sarva
  ashtakavarga_shodasha
  sudarshana
  kp_chart
  moon_chart
  sun_chart
  arudha_lagna
  bhava_lagna
  hora_lagna
  kp_bhava
  equal_bhava
  sripathi_bhava
  karkamsha
  karkamsha_d1
  karkamsha_d9
  numerology_chaldean
  numerology_loshu
  person_numerology
  yoga_gaja_kesari
  yoga_guru_mangal
  yoga_budha_aditya
  yoga_chandra_mangal
  yoga_raj
  yoga_pancha_mahapurusha
  yoga_daridra
  yoga_dhan
  yoga_malefic
  yoga_rare
  yoga_special
  yoga_spiritual
  yoga_shubh
  yoga_viparitha_raja
  yoga_kalpadruma
  yoga_kala_sarpa
  yoga_guru_mangal_only
  dosha_kala_sarpa
  dosha_angarak
  dosha_guru_chandal
  dosha_shrapit
  dosha_sade_sati
  dosha_pitra
  dosha_dhaiya

  panchanga
  choghadiya
  hora_times
  lagna_times
  muhurat
  avakhada_chakra

  remedy_yantra
  remedy_mantra
  remedy_general
  remedy_gemstone
  remedy_lal_kitab
  remedy_vedic_remedies
  shadbala
  dasha_vimshottari
  dasha_chara
  dasha_yogini
  dasha_ashtottari
  dasha_tribhagi
  dasha_tribhagi_40
  dasha_shodashottari
  dasha_dwadashottari
  dasha_panchottari
  dasha_chaturshitisama
  dasha_satabdika
  dasha_dwisaptati
  dasha_shastihayani
  dasha_shattrimshatsama
  dasha_summary
  dasha_3months
  dasha_6months
  dasha_report_1year
  dasha_report_2years
  dasha_report_3years
  kp_planets_cusps
  kp_ruling_planets
  kp_bhava_details
  kp_significations
  kp_horary
  kp_house_significations
  kp_planet_significators
  kp_interlinks
  kp_interlinks_advanced
  kp_interlinks_sl
  kp_nakshatra_nadi
  kp_fortuna
  shodasha_varga_signs
  mandi
  gulika

  // New chart types for integrated routes
  birth_panchanga       // Birth-time panchanga (universal, stored once per client)
  // NOTE: choghadiya, hora_times, lagna_times, muhurat already defined above
  gl_chart              // Gati Kalagna chart
  karaka_strength       // Karaka strength analysis
  yukteswar_transit     // Yukteswar system transit chart

  @@schema("app_clients")
}

enum RemedyType {
  gemstone
  mantra
  puja
  charity
  lifestyle
  yantra
  fasting
  other

  @@schema("app_clients")
}

enum RemedyStatus {
  prescribed
  in_progress
  completed
  discontinued

  @@schema("app_clients")
}

enum ImportStatus {
  pending
  processing
  completed
  failed
  partially_completed

  @@schema("app_clients")
}

enum ChartGenerationStatus {
  pending
  processing
  completed
  failed

  @@schema("app_clients")
}

enum ImportType {
  excel
  csv
  ocr

  @@schema("app_clients")
}

enum YogaDoshaCategory {
  yoga
  dosha

  @@schema("app_clients")
}

// Models
model Client {
  id            String    @id @default(uuid()) @db.Uuid
  tenantId      String    @map("tenant_id") @db.Uuid
  clientCode    String    @map("client_code") @db.VarChar(20)

  // Basic Information
  fullName      String    @map("full_name") @db.VarChar(200)
  phonePrimary  String?   @map("phone_primary") @db.VarChar(20)
  phoneSecondary String?  @map("phone_secondary") @db.VarChar(20)
  email         String?   @db.VarChar(255)
  photoUrl      String?   @map("photo_url") @db.VarChar(500)

  // Birth Details
  birthDate     DateTime? @map("birth_date") @db.Date
  birthTime     DateTime? @map("birth_time") @db.Time
  birthPlace    String?   @map("birth_place") @db.VarChar(300)
  birthLatitude Decimal?  @map("birth_latitude") @db.Decimal(10, 7)
  birthLongitude Decimal? @map("birth_longitude") @db.Decimal(10, 7)
  birthTimezone String?   @map("birth_timezone") @db.VarChar(50)
  birthTimeKnown Boolean  @default(true) @map("birth_time_known")
  birthTimeAccuracy BirthTimeAccuracy @default(exact) @map("birth_time_accuracy")

  // Personal Details
  gender        Gender?
  maritalStatus MaritalStatus? @map("marital_status")
  occupation    String?   @db.VarChar(200)
  businessDetails String? @map("business_details") @db.Text
  currentSituation String? @map("current_situation") @db.Text
  specialConsiderations String? @map("special_considerations") @db.Text

  // Address
  addressLine1  String?   @map("address_line1") @db.VarChar(300)
  addressLine2  String?   @map("address_line2") @db.VarChar(300)
  city          String?   @db.VarChar(100)
  state         String?   @db.VarChar(100)
  postalCode    String?   @map("postal_code") @db.VarChar(20)
  country       String?   @db.VarChar(100)

  // Organization
  tags          Json?     @default("[]") @db.JsonB
  metadata      Json?     @default("{}") @db.JsonB

  // Generation Status Tracking
  generationStatus ChartGenerationStatus @default(pending) @map("generation_status")
  chartsVersion Int @default(1) @map("charts_version")

  // Source & Audit
  source        ClientSource @default(manual)
  createdBy     String?   @map("created_by") @db.Uuid

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  // Relations
  familyLinksFrom   ClientFamilyLink[] @relation("FamilyLinkFrom")
  familyLinksTo     ClientFamilyLink[] @relation("FamilyLinkTo")
  consultations     ClientConsultation[]
  savedCharts       ClientSavedChart[]
  notes             ClientNote[]
  remedies          ClientRemedy[]
  activityLogs      ClientActivityLog[]
  yogaDoshas        ClientYogaDosha[]

  // Indexes
  @@unique([id, tenantId])
  @@unique([tenantId, clientCode])
  @@unique([tenantId, phonePrimary], name: "unique_tenant_phone")
  @@index([tenantId])
  @@index([tenantId, fullName])
  @@index([tenantId, email])
  @@index([tenantId, birthDate])
  @@index([tenantId, createdAt])
  @@index([tenantId, deletedAt])
  @@index([tenantId, phonePrimary])
  @@index([tenantId, clientCode])

  // GIN Index for JSONB Search
  @@index([tags], type: Gin)

  @@map("clients")
  @@schema("app_clients")
}

model ClientFamilyLink {
  id                String   @id @default(uuid()) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  clientId          String   @map("client_id") @db.Uuid
  relatedClientId   String   @map("related_client_id") @db.Uuid
  relationshipType  RelationshipType @map("relationship_type")
  relationshipLabel String?  @map("relationship_label") @db.VarChar(100)
  notes             String?  @db.Text
  createdAt         DateTime @default(now()) @map("created_at")
  createdBy         String?  @map("created_by") @db.Uuid

  // Relations
  client        Client @relation("FamilyLinkFrom", fields: [clientId], references: [id], onDelete: Cascade)
  relatedClient Client @relation("FamilyLinkTo", fields: [relatedClientId], references: [id], onDelete: Cascade)

  // Constraints
  @@unique([id, tenantId])
  @@unique([clientId, relatedClientId])
  @@index([tenantId])
  @@index([clientId])
  @@index([relatedClientId])

  @@map("client_family_links")
  @@schema("app_clients")
}

model ClientConsultation {
  id               String    @id @default(uuid()) @db.Uuid
  tenantId         String    @map("tenant_id") @db.Uuid
  clientId         String    @map("client_id") @db.Uuid
  bookingId        String?   @map("booking_id") @db.Uuid
  reportId         String?   @map("report_id") @db.Uuid
  consultationType ConsultationType @map("consultation_type")
  sessionNotes     String?   @map("session_notes") @db.Text
  keyObservations  String?   @map("key_observations") @db.Text
  followUpDate     DateTime? @map("follow_up_date") @db.Date
  status           ConsultationStatus @default(completed)
  consultationDate DateTime  @map("consultation_date")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  createdBy        String?   @map("created_by") @db.Uuid

  // Relations
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  remedies ClientRemedy[]

  @@index([tenantId])
  @@index([clientId])
  @@index([bookingId])
  @@unique([id, tenantId])
  @@index([tenantId, consultationDate])

  @@map("client_consultations")
  @@schema("app_clients")
}

model ClientSavedChart {
  id            String    @id @default(uuid()) @db.Uuid
  tenantId      String    @map("tenant_id") @db.Uuid
  clientId      String    @map("client_id") @db.Uuid
  chartType     ChartType @map("chart_type")
  system        String    @default("lahiri") @db.VarChar(20)
  chartName     String?   @map("chart_name") @db.VarChar(200)
  chartData     Json      @map("chart_data") @db.JsonB
  chartConfig   Json?     @map("chart_config") @db.JsonB
  chartImageUrl String?   @map("chart_image_url") @db.VarChar(500)
  calculatedAt  DateTime  @map("calculated_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  createdBy     String?   @map("created_by") @db.Uuid

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([clientId])
  @@unique([id, tenantId])
  @@unique([tenantId, clientId, chartType, system])
  @@index([clientId, chartType])

  @@map("client_saved_charts")
  @@schema("app_clients")
}

model ClientYogaDosha {
  id              String              @id @default(uuid()) @db.Uuid
  tenantId        String              @map("tenant_id") @db.Uuid
  clientId        String              @map("client_id") @db.Uuid
  category        YogaDoshaCategory                                    // 'yoga' or 'dosha'
  type            String              @db.VarChar(100)                  // 'budha_aditya', 'angarak', etc.
  isPresent       Boolean             @default(false) @map("is_present")
  system          String              @default("lahiri") @db.VarChar(20)
  analysisData    Json                @map("analysis_data") @db.JsonB   // Full raw JSON from engine
  calculatedAt    DateTime            @map("calculated_at")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  // Relations
  client          Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Constraints â€” one yoga/dosha type per client per system
  @@unique([tenantId, clientId, category, type, system])
  @@index([tenantId])
  @@index([clientId])
  @@index([clientId, isPresent])
  @@index([clientId, category, isPresent])

  @@map("client_yoga_doshas")
  @@schema("app_clients")
}

model ClientNote {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  clientId    String   @map("client_id") @db.Uuid
  noteContent String   @map("note_content") @db.Text
  isPinned    Boolean  @default(false) @map("is_pinned")
  createdBy   String?  @map("created_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@unique([id, tenantId])
  @@index([clientId])
  @@map("client_notes")
  @@schema("app_clients")
}

model ClientRemedy {
  id               String   @id @default(uuid()) @db.Uuid
  tenantId         String   @map("tenant_id") @db.Uuid
  clientId         String   @map("client_id") @db.Uuid
  consultationId   String?  @map("consultation_id") @db.Uuid
  remedyType       RemedyType @map("remedy_type")
  remedyTitle      String   @map("remedy_title")
  remedyDescription String? @map("remedy_description") @db.Text
  instructions     String?  @db.Text
  startDate        DateTime? @map("start_date") @db.Date
  endDate          DateTime? @map("end_date") @db.Date
  status           RemedyStatus @default(prescribed)
  followUpNotes    String?  @map("follow_up_notes") @db.Text
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  createdBy        String?  @map("created_by") @db.Uuid

  client         Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  consultation   ClientConsultation? @relation(fields: [consultationId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@unique([id, tenantId])
  @@index([clientId])
  @@map("client_remedies")
  @@schema("app_clients")
}

model ClientImport {
  id                String   @id @default(uuid()) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  fileName          String   @map("file_name")
  fileUrl           String   @map("file_url")
  importType        ImportType @map("import_type")
  status            ImportStatus @default(pending)
  totalRecords      Int      @default(0) @map("total_records")
  successfulRecords Int      @default(0) @map("successful_records")
  failedRecords     Int      @default(0) @map("failed_records")
  duplicateRecords  Int      @default(0) @map("duplicate_records")
  columnMapping     Json?    @map("column_mapping")
  errors            Json?
  createdBy         String?  @map("created_by") @db.Uuid
  startedAt         DateTime? @map("started_at")
  completedAt       DateTime? @map("completed_at")
  createdAt         DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@map("client_imports")
  @@schema("app_clients")
}

model ClientActivityLog {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  clientId        String?  @map("client_id") @db.Uuid
  userId          String?  @map("user_id") @db.Uuid
  action          String   @db.VarChar(100)
  details         Json?    @db.JsonB
  ipAddress       String?  @map("ip_address") @db.VarChar(45)
  userAgent       String?  @map("user_agent") @db.Text
  deviceType      String?  @map("device_type") @db.VarChar(50)
  deviceName      String?  @map("device_name") @db.VarChar(100)
  timestamp       DateTime @default(now())

  // Relations
  client          Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([clientId])
  @@index([userId])
  @@index([timestamp])
  @@map("client_activity_logs")
  @@schema("app_clients")
}
