generator client {
  provider        = "prisma-client-js"
  output          = "../src/generated/prisma"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["app_auth"]
}

model User {
  id                      String                   @id @default(uuid()) @db.Uuid
  tenantId                String                   @map("tenant_id") @db.Uuid
  email                   String                   @unique @db.VarChar(255)
  passwordHash            String?                  @map("password_hash") @db.VarChar(255)
  name                    String                   @db.VarChar(100)
  avatarUrl               String?                  @map("avatar_url") @db.VarChar(500)
  role                    UserRole                 @default(user)
  status                  UserStatus               @default(pending_verification)
  emailVerified           Boolean                  @default(false) @map("email_verified")
  emailVerifiedAt         DateTime?                @map("email_verified_at")
  lastLoginAt             DateTime?                @map("last_login_at")
  metadata                Json?                    @default("{}")
  createdAt               DateTime                 @default(now()) @map("created_at")
  updatedAt               DateTime                 @updatedAt @map("updated_at")
  deletedAt               DateTime?                @map("deleted_at")
  emailVerificationTokens EmailVerificationToken[]
  loginAttempts           LoginAttempt[]
  oauthAccounts           OAuthAccount[]
  passwordResetTokens     PasswordResetToken[]
  sessions                Session[]

  @@index([tenantId])
  @@index([email])
  @@index([status])
  @@map("auth_users")
  @@schema("app_auth")
}

model Session {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @map("user_id") @db.Uuid
  tokenHash        String   @unique @map("token_hash") @db.VarChar(255)
  refreshTokenHash String   @unique @map("refresh_token_hash") @db.VarChar(255)
  ipAddress        String?  @map("ip_address") @db.VarChar(45)
  userAgent        String?  @map("user_agent") @db.VarChar(500)
  deviceType       String?  @map("device_type") @db.VarChar(50)
  deviceName       String?  @map("device_name") @db.VarChar(100)
  isActive         Boolean  @default(true) @map("is_active")
  expiresAt        DateTime @map("expires_at")
  lastActivityAt   DateTime @default(now()) @map("last_activity_at")
  createdAt        DateTime @default(now()) @map("created_at")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("auth_sessions")
  @@schema("app_auth")
}

model PasswordResetToken {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  tokenHash String    @unique @map("token_hash") @db.VarChar(255)
  used      Boolean   @default(false)
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  usedAt    DateTime? @map("used_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("auth_password_reset_tokens")
  @@schema("app_auth")
}

model OAuthAccount {
  id             String        @id @default(uuid()) @db.Uuid
  userId         String        @map("user_id") @db.Uuid
  provider       OAuthProvider
  providerUserId String        @map("provider_user_id") @db.VarChar(255)
  accessToken    String?       @map("access_token")
  refreshToken   String?       @map("refresh_token")
  profileData    Json?         @map("profile_data")
  tokenExpiresAt DateTime?     @map("token_expires_at")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@index([userId])
  @@map("auth_oauth_accounts")
  @@schema("app_auth")
}

model LoginAttempt {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String?  @map("user_id") @db.Uuid
  email         String   @db.VarChar(255)
  ipAddress     String   @map("ip_address") @db.VarChar(45)
  success       Boolean
  failureReason String?  @map("failure_reason") @db.VarChar(255)
  createdAt     DateTime @default(now()) @map("created_at")
  deviceName    String?  @map("device_name") @db.VarChar(100)
  deviceType    String?  @map("device_type") @db.VarChar(50)
  userAgent     String?  @map("user_agent") @db.VarChar(500)
  user          User?    @relation(fields: [userId], references: [id])

  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
  @@map("auth_login_attempts")
  @@schema("app_auth")
}

model TokenBlacklist {
  id        String    @id @default(uuid()) @db.Uuid
  tokenHash String    @unique @map("token_hash") @db.VarChar(255)
  tokenType TokenType @map("token_type")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([tokenHash])
  @@index([expiresAt])
  @@map("auth_token_blacklist")
  @@schema("app_auth")
}

model InvitationToken {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  tokenHash String    @unique @map("token_hash") @db.VarChar(255)
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([tokenHash])
  @@index([userId])
  @@index([expiresAt])
  @@map("auth_invitation_tokens")
  @@schema("app_auth")
}

model EmailVerificationToken {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  tokenHash String    @unique @map("token_hash") @db.VarChar(255)
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([userId])
  @@index([expiresAt])
  @@map("auth_email_verification_tokens")
  @@schema("app_auth")
}

enum UserRole {
  user
  admin
  moderator

  @@schema("app_auth")
}

enum UserStatus {
  active
  suspended
  pending_verification
  deleted

  @@schema("app_auth")
}

enum TokenType {
  access
  refresh

  @@schema("app_auth")
}

enum OAuthProvider {
  google
  github
  apple

  @@schema("app_auth")
}
