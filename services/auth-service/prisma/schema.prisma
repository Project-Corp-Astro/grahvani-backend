// Prisma Schema for Auth Service
// This schema is ONLY for auth-service database tables

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============ ENUMS ============

enum UserRole {
  user
  admin
  moderator
}

enum UserStatus {
  active
  suspended
  pending_verification
  deleted
}

enum TokenType {
  access
  refresh
}

enum OAuthProvider {
  google
  github
  apple
}

// ============ MODELS ============

model User {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  email           String    @unique @db.VarChar(255)
  passwordHash    String?   @map("password_hash") @db.VarChar(255)
  name            String    @db.VarChar(100)
  avatarUrl       String?   @map("avatar_url") @db.VarChar(500)
  role            UserRole  @default(user)
  status          UserStatus @default(pending_verification)
  emailVerified   Boolean   @default(false) @map("email_verified")
  emailVerifiedAt DateTime? @map("email_verified_at")
  lastLoginAt     DateTime? @map("last_login_at")
  metadata        Json?     @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  sessions            Session[]
  passwordResetTokens PasswordResetToken[]
  oauthAccounts       OAuthAccount[]
  loginAttempts       LoginAttempt[]

  @@map("auth_users")
  @@index([tenantId])
  @@index([email])
  @@index([status])
}

model Session {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @map("user_id") @db.Uuid
  tokenHash        String   @unique @map("token_hash") @db.VarChar(255)
  refreshTokenHash String   @unique @map("refresh_token_hash") @db.VarChar(255)
  ipAddress        String?  @map("ip_address") @db.VarChar(45)
  userAgent        String?  @map("user_agent") @db.VarChar(500)
  deviceType       String?  @map("device_type") @db.VarChar(50)
  deviceName       String?  @map("device_name") @db.VarChar(100)
  isActive         Boolean  @default(true) @map("is_active")
  expiresAt        DateTime @map("expires_at")
  lastActivityAt   DateTime @default(now()) @map("last_activity_at")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("auth_sessions")
  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  tokenHash String    @unique @map("token_hash") @db.VarChar(255)
  used      Boolean   @default(false)
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  usedAt    DateTime? @map("used_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("auth_password_reset_tokens")
  @@index([userId])
  @@index([tokenHash])
}

model OAuthAccount {
  id             String        @id @default(uuid()) @db.Uuid
  userId         String        @map("user_id") @db.Uuid
  provider       OAuthProvider
  providerUserId String        @map("provider_user_id") @db.VarChar(255)
  accessToken    String?       @map("access_token") @db.Text
  refreshToken   String?       @map("refresh_token") @db.Text
  profileData    Json?         @map("profile_data")
  tokenExpiresAt DateTime?     @map("token_expires_at")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@map("auth_oauth_accounts")
  @@index([userId])
}

model LoginAttempt {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String?  @map("user_id") @db.Uuid
  email         String   @db.VarChar(255)
  ipAddress     String   @map("ip_address") @db.VarChar(45)
  success       Boolean
  failureReason String?  @map("failure_reason") @db.VarChar(255)
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("auth_login_attempts")
  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
}

model TokenBlacklist {
  id        String    @id @default(uuid()) @db.Uuid
  tokenHash String    @unique @map("token_hash") @db.VarChar(255)
  tokenType TokenType @map("token_type")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@map("auth_token_blacklist")
  @@index([tokenHash])
  @@index([expiresAt])
}
