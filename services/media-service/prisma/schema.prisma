generator client {
  provider        = "prisma-client-js"
  output          = "../src/generated/prisma"
  previewFeatures = ["multiSchema"]
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("MEDIA_DATABASE_URL")
  directUrl = env("MEDIA_DIRECT_URL")
  schemas   = ["app_media"]
}

// ============ Enums ============

enum FileStatus {
  pending
  uploading
  uploaded
  processing
  ready
  failed
  deleted

  @@schema("app_media")
}

enum FileVisibility {
  public
  private
  authenticated

  @@schema("app_media")
}

enum FileCategory {
  image
  video
  document
  audio
  archive
  other

  @@schema("app_media")
}

// ============ Models ============

model File {
  id               String          @id @default(uuid()) @db.Uuid
  tenantId         String          @map("tenant_id") @db.Uuid
  userId           String          @map("user_id") @db.Uuid
  bucket           String          @db.VarChar(50)
  storagePath      String          @map("storage_path") @db.VarChar(500)
  filename         String          @db.VarChar(255)
  originalFilename String          @map("original_filename") @db.VarChar(255)
  mimeType         String          @map("mime_type") @db.VarChar(100)
  category         FileCategory    @default(other)
  size             BigInt
  checksum         String?         @db.VarChar(64)
  status           FileStatus      @default(pending)
  visibility       FileVisibility  @default(authenticated)
  metadata         Json            @default("{}")
  publicUrl        String?         @map("public_url") @db.VarChar(1000)
  uploadedAt       DateTime?       @map("uploaded_at")
  processedAt      DateTime?       @map("processed_at")
  expiresAt        DateTime?       @map("expires_at")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  deletedAt        DateTime?       @map("deleted_at")

  variants         FileVariant[]

  @@unique([bucket, storagePath])
  @@index([tenantId, userId])
  @@index([tenantId, status])
  @@index([tenantId, bucket])
  @@index([category])
  @@index([mimeType])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("files")
  @@schema("app_media")
}

model FileVariant {
  id          String   @id @default(uuid()) @db.Uuid
  fileId      String   @map("file_id") @db.Uuid
  name        String   @db.VarChar(50)
  storagePath String   @map("storage_path") @db.VarChar(500)
  mimeType    String   @map("mime_type") @db.VarChar(100)
  size        BigInt
  width       Int?
  height      Int?
  quality     Int?
  format      String?  @db.VarChar(20)
  publicUrl   String?  @map("public_url") @db.VarChar(1000)
  createdAt   DateTime @default(now()) @map("created_at")

  file        File     @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@unique([fileId, name])
  @@index([fileId])
  @@map("file_variants")
  @@schema("app_media")
}
